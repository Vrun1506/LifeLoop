# API Contracts

## Backend POST `/parent-request`

- **Purpose**: Capture family consent details after signup, upload optional voice samples, and trigger the parent confirmation email.
- **Auth**: Requires `Authorization: Bearer <Supabase access token>` (obtained via `supabase.auth.getSession()` on the client).
- **Request Body**: `multipart/form-data`
  - `instagramUsername` (`string`, required) – Supabase profile handle to associate with import jobs.
  - `parentEmail` (`string`, required) – Destination for the consent email.
  - `consentGranted` (`"true"`, required) – Must be the literal string `"true"`; otherwise the request is rejected.
  - `voiceSample` (`File`, optional) – Audio upload (≥10s recommended). Stored in Cloudflare R2, then passed to ElevenLabs to create a reusable `voice_profile_id`.
- **Success Response** `200`
  ```json
  {
    "message": "Parent confirmation email sent.",
    "voice_sample_url": "https://cdn.lifeloop.family/voice-samples/<uid>/<filename>",
    "voice_profile_id": "aaaa1111-bbbb-2222-cccc-3333dddd4444",
    "expires_at": "2025-11-02T12:00:00.000Z"
  }
  ```
- **Failure Responses**
  - `400` – Missing instagram username, parent email, or consent flag.
  - `401` – Missing/invalid Supabase access token.
  - `500` – Upload, Supabase, ElevenLabs, or Resend dispatch failure.
- **Notes**
  - Upserts `user_profiles` with `parent_email`, resets `is_parent_confirmed=false`, and records both `voice_sample_url` and `voice_profile_id` (when available).
  - Inserts a `parent_confirmations` row (`status='pending'`, 72h expiry) and dispatches the consent email via Resend.
  - Frontend needs `NEXT_PUBLIC_BACKEND_API_BASE_URL` to point at this Flask host; server actions use `BACKEND_API_BASE_URL`.

## GET `/api/parent-request/confirm?token=<uuid>`

- **Purpose**: Parent/guardian completes consent when they click the email link.
- **Auth**: None (tokenised link; uses Supabase service role on the backend).
- **Query Params**
  - `token` (`string`, required) – Confirmation token generated by the POST endpoint.
- **Responses**
  - `200` HTML – Confirmation succeeded or was already completed.
  - `400` HTML – Invalid/missing token or an internal error (message rendered in friendly layout for parents).
- **Side effects**
  - Sets `user_profiles.is_parent_confirmed=true` for the student.
  - Updates `parent_confirmations.status='confirmed'` and stamps `responded_at`.
